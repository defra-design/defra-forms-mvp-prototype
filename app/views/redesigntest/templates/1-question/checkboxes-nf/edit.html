{% extends "layouts/main.html" %}
{% from "components/service-header/macro.njk" import serviceHeader %}
{% set pageName = "Edit checkbox question - Apply for a county parish holding number in England" %}
{% set headingPlaceholder = "Page heading" %}
{% set guidancePlaceholder = "" %}
{% block header %}
{{ serviceHeader({
organisationName: "Defra",
productName: "Forms Designer",
serviceName: "",
containerClasses: containerClasses,
accountName: "Chris Smith",
homepageLink: "/",
signOutLink: "/onboarding/sign-out-confirmation",
navigationItems: [
{ href: "/library.html", text: "Forms library", id: "nav-library" },
{ href: "/cph-overview/draft/complete-clean.html", text: "Overview", id: "nav-overview" },
{ href: "/redesigntest/listing", text: "Editor", id: "nav-editor" }
],
activeLinkId: "nav-editor"
}) }}

<div class="x-govuk-masthead x-govuk-masthead--large">
	<div class="govuk-width-container">
		{{ govukBackLink({ classes: "govuk-back-link--inverse govuk-!-margin-bottom-0", text: "Back to add and edit
		pages", href: "/redesigntest/listing.html" }) }}

		<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible"
			style="border-bottom: 1px solid white; margin-bottom: 0" />

		<div class="govuk-grid-row">
			<div class="govuk-grid-column-full-from-desktop">
				<h1 class="x-govuk-masthead__title">
					Food order form (user research)
				</h1>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
	<div class="govuk-grid-column-full">
		<div class="govuk-grid-row">
			<!-- Left Column for Form Controls -->
			<div class="govuk-grid-column-one-half-from-desktop" id="container" style="flex: 1 1 75%; overflow-y: auto">
				<div class="govuk-summary-card govuk-!-margin-top-0" style="border-left: 10px solid #008938">
					<div class="govuk-summary-card__content govuk-!-padding-top-0" style="background-color: #f3f2f1">

						<dl class="govuk-summary-list">
							<div class="govuk-summary-list__row">
								<dd class="govuk-summary-list__value">
									<!-- Dynamic Summary List -->

									<!-- Question Settings Container -->
									<div class="govuk-grid-row" id="page-settings-container-1">
										<div id="question-1">
											<div class="govuk-summary-card__content" style="margin-bottom: 0">
												<!-- Sub Navigation for Question -->
												<nav class="moj-sub-navigation govuk-!-padding-top-0 govuk-!-margin-bottom-2"
													aria-label="Sub navigation">
													<ul class="moj-sub-navigation__list" id="nav-list2">
														<li class="moj-sub-navigation__item">
															<a class="moj-sub-navigation__link" aria-current="page"
																href="#question-1-information-type">Question #</a>
														</li>
													</ul>
												</nav>

												<div class="govuk-summary-card__title-wrapper govuk-!-padding-top-0">
												</div>

												<span class="govuk-caption-l">Page #</span>
												<h2 class="govuk-heading-l">Edit question #</h2>

												<form id="s" action="/question-configuration-save" method="post">

													{% from "govuk/components/input/macro.njk" import govukInput %}
													{% from "govuk/components/textarea/macro.njk" import govukTextarea
													%}
													{% from "govuk/components/fieldset/macro.njk" import govukFieldset
													%}
													{% from "govuk/components/button/macro.njk" import govukButton %}
													{% from "govuk/components/summary-list/macro.njk" import
													govukSummaryList %}

													{{ govukInput({
													label: {
													text: "Question",
													classes: "govuk-label--m",
													isPageHeading: false
													},
													id: "multi-question-label-input-checkboxes",
													value: data['multi-question-label-input-checkboxes'],
													name: "multiQuestionLabelInputCheckboxes"
													}) }}

													<!-- Hint Text Area -->
													{{ govukTextarea({
													label: {
													text: "Hint text (optional)",
													classes: "govuk-label--m"
													},
													id: "multi-question-hint-text-input-radios",
													name: "multiQuestionHintTextInputRadios",
													value: data['multi-question-hint-text-input-radios'],
													classes: "govuk-textarea",
													rows: 3,
													describedBy: "multi-question-hint-text-input-radios"
													}) }}

													<!-- List config -->
													<div class="govuk-form-group">
														<h2 class="govuk-heading-m moj-add-another__heading"
															tabindex="-1">Create and edit your list of options</h2>

														<!-- Options Container -->
														<ol class="gem-c-reorderable-list js-enabled"
															id="options-container" data-module="reorderable-list">
															{% if
															data.formPages[data.currentPageIndex].questions[data.currentQuestionIndex].options
															and
															data.formPages[data.currentPageIndex].questions[data.currentQuestionIndex].options.length
															> 0 %}
															{% for option in
															data.formPages[data.currentPageIndex].questions[data.currentQuestionIndex].options
															%}
															<li class="gem-c-reorderable-list__item" draggable="true"
																data-index="{{ loop.index }}">
																<div class="gem-c-reorderable-list__wrapper">
																	<div class="gem-c-reorderable-list__content">
																		<!-- Display Paragraph with 'fauxlabel' -->
																		<p class="govuk-body fauxlabel option-label-display"
																			id="option-{{ loop.index }}-label-display">
																			{{ option.label }}
																		</p>

																		<!-- Hidden Input with Distinct Class -->
																		<input type="hidden"
																			id="option-{{ loop.index }}-label"
																			name="option[{{ loop.index }}][option_label]"
																			value="{{ option.label }}"
																			class="option-label-input-hidden">

																		<!-- Hidden Hint Input -->
																		<input class="option-hint-input" type="hidden"
																			id="option-{{ loop.index }}-hint"
																			name="option[{{ loop.index }}][option_hint]"
																			value="{{ option.hint }}">
																	</div>

																	<!-- Action buttons -->
																	<div class="gem-c-reorderable-list__actions">
																		<button
																			class="gem-c-button govuk-button govuk-button--secondary js-reorderable-list-up"
																			type="button" aria-label="Move option up"
																			style="display: none;">Up</button>
																		<button
																			class="gem-c-button govuk-button govuk-button--secondary js-reorderable-list-down"
																			type="button" aria-label="Move option down"
																			style="display: inline-block;">Down</button>
																		<button
																			class="gem-c-button govuk-button govuk-button--warning js-remove-option"
																			type="button"
																			aria-label="Remove option">Remove</button>

																	</div>
																	<div class="edit-item">
																		<a class="govuk-link govuk-link--no-visited-state"
																			href="editoption.html?index={{ loop.index }}">
																			Edit
																			<span class="govuk-visually-hidden">
																				option number {{ loop.index }}
																				{% if checkbox.label %} - {{
																				checkbox.label }}{% endif %}
																			</span>
																		</a>
																	</div>
																</div>
															</li>
															{% endfor %}
															{% else %}
															<li class="gem-c-reorderable-list__item">
																<p class="govuk-body">No checkbox options added yet.</p>
															</li>
															{% endif %}
														</ol>


														<div class="govuk-button-group">
															<!-- Add Option Button -->
															<button type="button"
																class="govuk-button govuk-button moj-add-another__add-button govuk-!-margin-bottom-4 govuk-!-margin-bottom-6"
																id="add-option-button">
																{% if data.checkboxList and data.checkboxList.length > 0
																%}
																Add another option
																{% else %}
																Add option
																{% endif %}
															</button>

															<!-- Edit List Button -->
															<button type="button"
																class="govuk-button govuk-button--inverse"
																id="edit-options-button">
																Edit list
															</button>
														</div>

														<!-- Make Optional Checkbox -->
														<div class="govuk-form-group">
															<div class="govuk-checkboxes--small">
																<div class="govuk-checkboxes__item">
																	<input class="govuk-checkboxes__input"
																		type="checkbox" id="makeOptional"
																		name="makeOptional"
																		value="{{ data['optional-label-q1'] }}">
																	<label class="govuk-label govuk-checkboxes__label"
																		for="makeOptional">
																		Make this question optional
																	</label>
																</div>
															</div>
														</div>


														<!-- Error Message Input -->
														{{ govukInput({
														label: {
														text: "Short description",
														classes: "govuk-label--m",
														isPageHeading: false
														},
														hint: {
														text: "Enter a short description for this question like 'licence
														period'. Short descriptions are used in error messages and on
														the check your answers page."
														},
														id: "error-message-input",
														name: "errorMessageInput"
														}) }}

														<div id="summary-container">
															<hr
																class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

															<!-- The dynamic summary list will be populated here -->
															<h2 class="govuk-heading-m">Question settings</h2>

															{{ govukSummaryList({
															classes: "govuk-summary-list govuk-section-break
															govuk-section-break--visible govuk-!-margin-bottom-6",
															rows: [
															{
															key: {
															text: "Type of information"
															},
															value: {
															html: "List: checkboxes"
															},
															actions: {
															items: [
															{
															href:
															"/redesigntest/templates/1-question/information-type.html",
															text: "Change",
															visuallyHiddenText: "name"
															}
															]
															}
															}
															]
															}) }}
														</div>
														<div class="moj-button-action">
															{{ govukButton({
															text: 'Save and continue',
															type: 'submit'
															}) }}
														</div>
													</div>
												</form>
											</div>
										</div>
									</div>
								</dd>
							</div>
						</dl>
					</div>
				</div>
			</div>

			<!-- Right Column for Preview -->
			<div class="govuk-grid-column-one-half-from-desktop" id="second-container"
				style="outline: solid 1px #008938; height: 100%; position: sticky; top: 0; padding: 20px; box-shadow: 5px 10px #008938;">
				<!-- Before content -->
				<div id="before-content" style="background-color: #cce2d8;">
					<p class="govuk-body-s"
						style="margin-bottom: 0; color: #005a30; padding: 2px 8px 3px; text-align: center;">Previews</p>
				</div>

				<div style="margin-top: 60px;">
					{% from "govuk/components/tabs/macro.njk" import govukTabs %}

					<div class="govuk-tabs" data-module="govuk-tabs">
						<h2 class="govuk-tabs__title">Contents</h2>
						<ul class="govuk-tabs__list">
							<li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
								<a class="govuk-tabs__tab" href="#tab-one">Page preview</a>
							</li>
							<li class="govuk-tabs__list-item">
								<a class="govuk-tabs__tab" href="#tab-two">Error messages</a>
							</li>
						</ul>

						<div class="govuk-tabs__panel" id="tab-one">
							<!-- Page Preview Content -->
							<p class="govuk-body-s" style="margin-bottom: 30px; border-bottom: #008938 1px;">
								<a href="#" class="govuk-link govuk-link--no-visited-state" rel="noreferrer noopener"
									target="_blank">Preview this page in a new tab</a>
							</p>

							<!-- Ensure this included template contains the #radio-list .govuk-radios element -->
							{% include "/redesigntest/templates/previews-more-than-1-question/radios/edit-v2.html" %}

							<a href="#edit-page" class="govuk-skip-link" style="margin-bottom: 30px!important;"
								data-module="govuk-skip-link">Skip to edit page</a>
						</div>

						<div class="govuk-tabs__panel" id="tab-two">
							<p class="govuk-body-s" style="margin-bottom: 30px; border-bottom: #008938 1px;">
								<a href="#" class="govuk-link govuk-link--no-visited-state" rel="noreferrer noopener"
									target="_blank">Preview error messages in a new tab</a>
							</p>
							<!-- Error Messages Content -->
							<!-- Error Messages Section -->
							<div class="govuk-error-summary" data-disable-auto-focus="true">
								<h2 class="govuk-error-summary__title">There is a problem</h2>
								<ul class="govuk-list govuk-error-summary__list">
									<!-- List of errors -->
									<li><a id="empty-input-error-shorttext" class="govuk-error-message">Select <span
												id="error-dynamic-text">[short description]</span></a></li>
								</ul>
							</div>
							<a href="#error-message-input-shorttext" class="govuk-skip-link"
								style="margin-bottom: 30px!important;" data-module="govuk-skip-link">Skip to edit short
								description</a>
						</div>
					</div>
				</div> <!-- Closing the govuk-tabs div -->

			</div>
		</div>

	</div>
</div>
</div>

<!-- Include SortableJS Library -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
	/* Styling for fauxlabel */
	.fauxlabel {
		border: 0;
		/* font-size: 1rem; */
		margin: 0;
		padding: 0.5rem;
	}

	.govuk-radios__item label {
		text-transform: capitalize;
	}

	.fauxlabel:focus,
	.fauxlabel:active {
		background-color: transparent !important;
	}

	.gem-c-reorderable-list .gem-c-reorderable-list__item:hover,
	.gem-c-reorderable-list__item:hover .fauxlabel {
		background-color: #fff;
		cursor: initial;
	}

	.gem-c-reorderable-list__item:hover .fauxlabel:focus {
		cursor: initial;
	}

	/* Highlighting styles */
	.highlight {
		background-color: #ffe5cc;
		border-bottom: 2px solid #ffb266;
	}

	.highlight-dragging {
		border: 2px dotted #ffb266;
		/* Example highlight style */
		background-color: #f0f0f0;
	}

	.highlight-moving {
		border: 2px dashed #ff0;
		/* During drag over */
	}

	/* Styles for the reorderable list */
	.gem-c-reorderable-list {
		list-style-type: none;
		margin: 0;
		padding: 0;
	}

	.gem-c-reorderable-list__item {
		margin-bottom: 15px;
		border-left: 5px solid #008938;
		outline: 1px solid #b1b4b6;
		padding: 15px;
		background-color: #fff;
	}

	.gem-c-reorderable-list__wrapper {
		display: flex;
		align-items: center;
	}

	.gem-c-reorderable-list__content {
		flex-grow: 1;
	}

	.gem-c-reorderable-list__actions {
		display: none;
		/* Hide by default */
		flex-direction: column;
		margin-left: 15px;
	}

	.gem-c-reorderable-list__actions .govuk-button {
		margin-bottom: 10px;
	}

	.govuk-body.fauxlabel.option-label-display {
		white-space: normal;
		/* Allow text to wrap */
		word-wrap: break-word;
		/* Break long words if necessary */
		overflow-wrap: break-word;
		/* Ensure wrapping for long words */
	}


	.sortable-ghost {
		opacity: 0.4;
	}

	.sortable-chosen {
		background-color: #e5f5ff;
	}

	/* Style for hover state of the list item */
	.gem-c-reorderable-list__item:hover {
		background-color: #f0f0f0;
		cursor: move;
	}

	/* Style for the chosen item (when selected) */
	.gem-c-reorderable-list__item.sortable-chosen {
		background-color: #e5f5ff;
		outline: 4px solid #ffdd00;
		box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
	}

	#second-container {
		padding: 0;
		box-sizing: border-box;
	}

	#second-container>* {
		padding-left: 0px;
		z-index: 2;
	}

	.border-left-container {
		border-left: 10px solid #ffb266;
		padding-left: 20px;
	}
</style>

<!-- Consolidated and Updated JavaScript -->
<script>
	document.addEventListener('DOMContentLoaded', function () {
		// DOM Elements
		const domElements = {
			multiQuestionLabelInputCheckboxes: document.getElementById('multi-question-label-input-checkboxes'),
			multiQuestionOutputRadios: document.getElementById('multi-question-output-radios'),
			hintTextInput: document.getElementById('multi-question-hint-text-input-radios'),
			multiQuestionHintTextOutputRadios: document.getElementById('multi-question-hint-text-output-radios'),
			makeOptionalCheckbox: document.getElementById('makeOptional'),
			pageHeadingInputRadios: document.getElementById('page-heading-input-radios'),
			dynamicHeading: document.getElementById('dynamic-heading'),
			guidanceTextareaRadios: document.getElementById('guidance-textarea-radios'),
			guidanceParagraph: document.getElementById('guidance-paragraph'),
			errorMessageInput: document.getElementById('error-message-input'),
			errorDynamicText: document.getElementById('error-dynamic-text'),
			optionsContainer: document.getElementById('options-container'),
			addOptionButton: document.getElementById('add-option-button'),
			addOptionContainer: document.querySelector('.moj-button-action'), // Parent container
			editOptionsButton: document.getElementById('edit-options-button'),
			radioList: document.querySelector('#radio-list .govuk-radios') // Ensure #radio-list exists in included template
		};

		let sortableInstance;
		let editMode = false; // Track whether edit mode is active
		let draggedOptionIndex = null; // To track the index of the dragged option

		// Initialize all functionality
		initializeEventListeners();
		initializeOptionsFunctionality();

		function initializeEventListeners() {
			// Update question label
			if (domElements.multiQuestionLabelInputCheckboxes && domElements.multiQuestionOutputRadios) {
				domElements.multiQuestionLabelInputCheckboxes.addEventListener('input', updateQuestionLabel);
				applyHighlightOnFocus(domElements.multiQuestionLabelInputCheckboxes, domElements.multiQuestionOutputRadios);
			}

			// Update hint text
			if (domElements.hintTextInput && domElements.multiQuestionHintTextOutputRadios) {
				domElements.hintTextInput.addEventListener('input', updateHintText);
				applyHighlightOnFocus(domElements.hintTextInput, domElements.multiQuestionHintTextOutputRadios);
				domElements.hintTextInput.addEventListener('focus', showPlaceholderHint);
				domElements.hintTextInput.addEventListener('blur', clearPlaceholderHint);
			}

			// Update error message
			if (domElements.errorMessageInput && domElements.errorDynamicText) {
				domElements.errorMessageInput.addEventListener('input', updateErrorMessage);
				applyHighlightOnFocus(domElements.errorMessageInput, domElements.errorDynamicText);
			}

			// Redirect to add.html on clicking Add Another Option
			domElements.addOptionButton.addEventListener('click', () => {
				window.location.href = 'add.html';
			});

			// Handle edit mode toggle
			domElements.editOptionsButton.addEventListener('click', toggleEditMode);
		}

		function updateQuestionLabel() {
			const suffix = domElements.makeOptionalCheckbox && domElements.makeOptionalCheckbox.checked ? ' (optional)' : '';
			domElements.multiQuestionOutputRadios.textContent = (domElements.multiQuestionLabelInputCheckboxes.value || 'Question') + suffix;
		}

		function updateHintText() {
			domElements.multiQuestionHintTextOutputRadios.textContent = domElements.hintTextInput.value || '';
		}

		function updateErrorMessage() {
			domElements.errorDynamicText.textContent = domElements.errorMessageInput.value.trim() || '[short description]';
		}

		function showPlaceholderHint() {
			if (!domElements.hintTextInput.value) {
				domElements.multiQuestionHintTextOutputRadios.textContent = 'Hint text';
			}
		}

		function clearPlaceholderHint() {
			if (!domElements.hintTextInput.value) {
				domElements.multiQuestionHintTextOutputRadios.textContent = '';
			}
		}

		function applyHighlightOnFocus(inputElement, targetElement) {
			if (inputElement && targetElement) {
				inputElement.addEventListener('focus', () => targetElement.classList.add('highlight'));
				inputElement.addEventListener('blur', () => targetElement.classList.remove('highlight'));

				if (document.activeElement === inputElement) {
					targetElement.classList.add('highlight');
				}
			}
		}

		function initializeOptionsFunctionality() {
			// Build preview for pre-rendered options
			const preRenderedItems = document.querySelectorAll('#options-container .gem-c-reorderable-list__item');
			preRenderedItems.forEach((item, index) => {
				const labelValue = item.querySelector('.option-label-display').textContent || `Option ${index + 1}`;
				const hintValue = item.querySelector('.option-hint-input') ? item.querySelector('.option-hint-input').value : '';
				addOptionToPreview(index, labelValue, hintValue);
				addOptionEventListeners(item, index);
			});

			// Initialize sortable functionality
			initializeSortable();
		}

		function addOptionEventListeners(item, index) {
			const upButton = item.querySelector('.js-reorderable-list-up');
			const downButton = item.querySelector('.js-reorderable-list-down');
			const removeButton = item.querySelector('.js-remove-option');
			const editButton = item.querySelector('.js-edit-option'); // New Edit Button

			// Click event listener for Move Up button
			upButton.addEventListener('click', function (event) {
				if (!editMode) return; // Only allow in edit mode
				const prevItem = item.previousElementSibling;
				if (prevItem) {
					item.parentNode.insertBefore(item, prevItem);
					// The new index is the index of the item after moving up
					const newIndex = Array.from(item.parentNode.children).indexOf(item);
					updatePreview(newIndex);
					// Use setTimeout to ensure DOM updates before setting focus and highlighting
					setTimeout(() => {
						const upBtn = item.querySelector('.js-reorderable-list-up');
						const downBtn = item.querySelector('.js-reorderable-list-down');
						if (upBtn && upBtn.style.display !== 'none') {
							upBtn.focus();
						} else if (downBtn && downBtn.style.display !== 'none') {
							downBtn.focus();
						}
					}, 0);
				}
			});

			// Click event listener for Move Down button
			downButton.addEventListener('click', function (event) {
				if (!editMode) return; // Only allow in edit mode
				const nextItem = item.nextElementSibling;
				if (nextItem) {
					item.parentNode.insertBefore(nextItem, item);
					// The new index is the index of the item after moving down
					const newIndex = Array.from(item.parentNode.children).indexOf(item);
					updatePreview(newIndex);
					// Use setTimeout to ensure DOM updates before setting focus and highlighting
					setTimeout(() => {
						const upBtn = item.querySelector('.js-reorderable-list-up');
						const downBtn = item.querySelector('.js-reorderable-list-down');
						if (upBtn && upBtn.style.display !== 'none') {
							upBtn.focus();
						} else if (downBtn && downBtn.style.display !== 'none') {
							downBtn.focus();
						}
					}, 0);
				}
			});

			// Click event listener for Remove button
			removeButton.addEventListener('click', function (event) {
				if (!editMode) return; // Only allow in edit mode
				item.parentNode.removeChild(item);
				removeOptionFromPreview(index);
				updatePreview();
				// No need to set focus here as the button is removed
			});

			// Click event listener for Edit button
			if (editButton) {
				editButton.addEventListener('click', function () {
					const newLabel = prompt('Edit option label:', item.querySelector('.option-label-display').textContent);
					if (newLabel !== null && newLabel.trim() !== "") {
						item.querySelector('.option-label-display').textContent = newLabel;
						item.querySelector('.option-label-input-hidden').value = newLabel;
						updateOptionPreview(index, newLabel);
					} else {
						alert('Option label cannot be empty.');
					}
				});
			}

			// **New Code Start: Add focus and blur event listeners to action buttons **
			// Function to handle highlighting the corresponding preview item
			function handleActionFocus() {
				// Find the current index of the item
				const currentIndex = Array.from(domElements.optionsContainer.children).indexOf(item);
				if (currentIndex === -1) return; // Item might have been removed

				// Find the corresponding preview item
				const previewItem = document.getElementById(`preview-option-${currentIndex}`);
				if (previewItem) {
					previewItem.classList.add('highlight');
				}
			}

			function handleActionBlur() {
				// Find the current index of the item
				const currentIndex = Array.from(domElements.optionsContainer.children).indexOf(item);
				if (currentIndex === -1) return; // Item might have been removed

				// Find the corresponding preview item
				const previewItem = document.getElementById(`preview-option-${currentIndex}`);
				if (previewItem) {
					previewItem.classList.remove('highlight');
				}
			}

			// Attach focus and blur event listeners to all action buttons within this item
			const actionButtons = [upButton, downButton, removeButton];
			actionButtons.forEach(button => {
				button.addEventListener('focus', handleActionFocus);
				button.addEventListener('blur', handleActionBlur);
			});

			// If there's an Edit button, attach the same listeners
			if (editButton) {
				editButton.addEventListener('focus', handleActionFocus);
				editButton.addEventListener('blur', handleActionBlur);
			}
			// **New Code End **
		}

		function toggleEditMode() {
			editMode = !editMode; // Toggle edit mode

			// Update the text of the Edit button
			domElements.editOptionsButton.textContent = editMode ? 'Save changes' : 'Edit list';

			// Update the class of the Edit button
			domElements.editOptionsButton.className = editMode
				? 'govuk-button govuk-button'
				: 'govuk-button govuk-button--inverse';

			// Show or hide actions (up/down/remove buttons) for reordering and deleting
			document.querySelectorAll('.gem-c-reorderable-list__actions').forEach(actions => {
				actions.style.display = editMode ? 'flex' : 'none';
			});

			// Show or hide edit-item links
			document.querySelectorAll('.edit-item').forEach(editItem => {
				editItem.style.display = editMode ? 'none' : '';
			});

			// Enable or disable sortable based on edit mode
			if (sortableInstance) {
				sortableInstance.option('disabled', !editMode);
			}

			// Manage up and down buttons based on the state
			manageUpDownButtons();

			// Hide or show the "Add another option" button
			if (domElements.addOptionButton) {
				domElements.addOptionButton.style.display = editMode ? 'none' : 'inline-block';
			}

			// Set focus to the first "Move Down" button in edit mode
			if (editMode) {
				const firstMoveDownButton = document.querySelector('.js-reorderable-list-down');
				if (firstMoveDownButton) {
					firstMoveDownButton.focus();
				}
			}
		}



		function updatePreview(highlightIndex = null) {
			const items = document.querySelectorAll('#options-container .gem-c-reorderable-list__item');
			const previewContainer = domElements.radioList;

			if (!previewContainer) {
				console.warn("Preview container ('#radio-list .govuk-radios') not found. Ensure the included template contains this element.");
				return;
			}

			// Clear existing preview
			previewContainer.innerHTML = '';

			// Rebuild preview and collect preview items
			const previewItems = [];
			items.forEach((item, index) => {
				// Update data-index attributes to keep them consistent
				item.setAttribute('data-index', index);

				const labelValue = item.querySelector('.option-label-display').textContent || `Option ${index + 1}`;
				const hintValue = item.querySelector('.option-hint-input') ? item.querySelector('.option-hint-input').value : '';
				addOptionToPreview(index, labelValue, hintValue);

				// Collect preview items for later highlighting
				previewItems.push(document.getElementById(`preview-option-${index}`));
			});

			// Remove 'highlight' from all preview items
			previewItems.forEach(item => {
				if (item) {
					item.classList.remove('highlight');
				}
			});

			// Add 'highlight' to the specified preview item
			if (highlightIndex !== null && previewItems[highlightIndex]) {
				previewItems[highlightIndex].classList.add('highlight');
			}

			manageUpDownButtons();
		}

		function removeOptionFromPreview(index) {
			const previewOption = document.getElementById(`preview-option-${index}`);
			if (previewOption) {
				previewOption.parentNode.removeChild(previewOption);
			}
			// After removal, update all preview items to ensure accurate indexing
			updatePreview();
		}

		function manageUpDownButtons() {
			const items = document.querySelectorAll('#options-container .gem-c-reorderable-list__item');
			items.forEach((item, index) => {
				const upButton = item.querySelector('.js-reorderable-list-up');
				const downButton = item.querySelector('.js-reorderable-list-down');
				upButton.style.display = editMode && index > 0 ? 'inline-block' : 'none';
				downButton.style.display = editMode && index < items.length - 1 ? 'inline-block' : 'none';
			});
		}

		function initializeSortable() {
			sortableInstance = new Sortable(domElements.optionsContainer, {
				animation: 150,
				handle: '.gem-c-reorderable-list__wrapper',
				draggable: '.gem-c-reorderable-list__item',
				ghostClass: 'sortable-ghost',
				disabled: true, // Disabled by default until edit mode is active
				onStart: function (evt) {
					const index = Array.from(evt.from.children).indexOf(evt.item);
					draggedOptionIndex = index;
					highlightDraggedOption(index);
				},
				onMove: function (evt) {
					// Optionally, you can highlight potential drop targets here
				},
				onEnd: function (evt) {
					unhighlightDraggedOption(draggedOptionIndex);
					draggedOptionIndex = null;
					// After reordering, determine the new index of the moved item
					const newIndex = Array.from(evt.from.children).indexOf(evt.item);
					updatePreview(newIndex);
				}
			});
		}

		function highlightDraggedOption(index) {
			const previewItem = document.getElementById(`preview-option-${index}`);
			if (previewItem) {
				previewItem.classList.add('highlight-dragging');
			}
		}

		function unhighlightDraggedOption(index) {
			const previewItem = document.getElementById(`preview-option-${index}`);
			if (previewItem) {
				previewItem.classList.remove('highlight-dragging');
			}
		}

		function addOptionToPreview(index, labelValue, hintValue) {
			const radioList = domElements.radioList;
			const hintHTML = hintValue ? `<div class="govuk-hint govuk-checkboxes__hint">${hintValue}</div>` : '';
			const newRadioHTML = `
		  <div class="govuk-checkboxes__item" id="preview-option-${index}">
			<input class="govuk-checkboxes__input" id="listPreview-option${index}" name="listPreview" type="checkbox" value="option${index}">
			<label class="govuk-label govuk-checkboxes__label" for="listPreview-option${index}">${labelValue || `Option ${parseInt(index) + 1}`}</label>
			${hintHTML}
		  </div>
		`;
			radioList.insertAdjacentHTML('beforeend', newRadioHTML);
		}

		function updateOptionPreview(index, value) {
			const radioLabel = domElements.radioList.querySelector(`label[for="listPreview-option${index}"]`);
			const hiddenInput = document.querySelector(`#options-container .gem-c-reorderable-list__item[data-index="${index}"] .option-label-input-hidden`);
			const hintInput = document.querySelector(`#options-container .gem-c-reorderable-list__item[data-index="${index}"] .option-hint-input`);
			const hintValue = hintInput ? hintInput.value : '';
			const hintElement = domElements.radioList.querySelector(`#preview-option-${index} .govuk-hint`);

			if (radioLabel) {
				radioLabel.textContent = value || `Option ${parseInt(index) + 1}`;
			}

			if (hiddenInput) {
				hiddenInput.value = value;
			}

			if (hintElement) {
				hintElement.textContent = hintValue || '';
			} else if (hintValue) {
				// If hintElement doesn't exist but there is hintValue, create the hint element
				const parentDiv = domElements.radioList.querySelector(`#preview-option-${index}`);
				if (parentDiv) {
					const hintHTML = `<div class="govuk-hint govuk-checkboxes__hint">${hintValue}</div>`;
					parentDiv.insertAdjacentHTML('beforeend', hintHTML);
				}
			}
		}
	});
</script>



<script>
	document.addEventListener("DOMContentLoaded", function () {
		var secondContainer = document.getElementById("second-container");
		var borderLeftContainerRadios = document.getElementById("border-left-container-radios");

		if (secondContainer && borderLeftContainerRadios) {
			// Scroll the `borderLeftContainerRadios` element into view within `second-container`
			borderLeftContainerRadios.scrollIntoView({
				behavior: "smooth",
				block: "nearest"
			});
			console.log("Scrolled to border-left-container-textarea within second-container");
		} else {
			console.log("second-container or border-left-container-textarea not found");
		}
	});
</script>

{% endblock %}